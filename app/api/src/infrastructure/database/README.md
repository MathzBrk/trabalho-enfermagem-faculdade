# Database Layer

This folder contains all database-related infrastructure using Prisma ORM.

## Structure

```
database/
├── prisma/
│   ├── schema.prisma       # Database schema
│   └── migrations/         # Migration history
├── lib/
│   └── prisma.ts          # Prisma Client singleton
├── generated/
│   └── prisma/            # Code generated by Prisma (do not edit)
└── index.ts               # Module public exports
```

## How to Use

### Importing Prisma Client

```typescript
// Using tsconfig alias
import prisma from "@infrastructure/database";

// Or using relative path
import { prisma } from "@/infrastructure/database";
```

### Usage Examples

```typescript
import prisma from "@infrastructure/database";

// Create
const employee = await prisma.employee.create({
  data: {
    name: "João Silva",
    email: "joao@example.com",
    password: "hashed_password",
    cpf: "12345678900",
    role: "EMPLOYEE",
  },
});

// Read
const employees = await prisma.employee.findMany({
  where: { isActive: true },
  include: {
    schedulingsReceived: true,
    applicationsReceived: true,
  },
});

// Update
const updated = await prisma.employee.update({
  where: { id: "employee-id" },
  data: { isActive: false },
});

// Delete (soft delete recommended)
const deleted = await prisma.employee.update({
  where: { id: "employee-id" },
  data: { deletedAt: new Date() },
});
```

## Useful Commands

```bash
# Generate Prisma Client after schema changes
npm run prisma:generate

# Create new migration
npx prisma migrate dev --name <migration_name>

# Apply migrations (production)
npm run prisma:migrate:deploy

# Open Prisma Studio (database GUI)
npm run prisma:studio
```

## Migrations

Migrations are versioned and stored in `prisma/migrations/`. Never edit migrations that have already been applied in production.

### Creating a New Migration

1. Edit the `schema.prisma`
2. Run: `npx prisma migrate dev --name <change_description>`
3. Prisma will automatically generate the SQL and apply it to the database

### Applying Migrations in Production

```bash
npm run prisma:migrate:deploy
```

## Schema

The `prisma/schema.prisma` file contains:

- **Enums**: Role, SchedulingStatus, ReportType, NotificationType
- **Models**: Employee, Vaccine, VaccineScheduling, VaccineApplication, Report, Notification

All models include:
- `id`: Unique UUID
- `createdAt`: Creation date
- `updatedAt`: Update date (automatic)
- `deletedAt`: Soft delete (optional)

## Best Practices

1. **Always use transactions** for operations that modify multiple tables:
```typescript
await prisma.$transaction([
  prisma.employee.create({ data: employeeData }),
  prisma.notification.create({ data: notificationData }),
]);
```

2. **Use select/include** to optimize queries:
```typescript
// Good - returns only necessary fields
const employee = await prisma.employee.findUnique({
  where: { id },
  select: { id: true, name: true, email: true },
});
```

3. **Implement soft delete** instead of deleting records:
```typescript
// Instead of delete
await prisma.employee.update({
  where: { id },
  data: { deletedAt: new Date() },
});
```

4. **Use types generated** by Prisma:
```typescript
import type { Employee, Prisma } from "@infrastructure/database";

// Use specific types
type EmployeeCreateInput = Prisma.EmployeeCreateInput;
type EmployeeWithRelations = Prisma.EmployeeGetPayload<{
  include: { notifications: true };
}>;
```

## Troubleshooting

### Error: "Prisma Client not found"

```bash
npm run prisma:generate
```

### Error: "Database not in sync"

```bash
npx prisma migrate dev
```

### Complete database reset (CAUTION!)

```bash
npx prisma migrate reset
```
